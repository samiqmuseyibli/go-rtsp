<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTSP Stream Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.10/dist/hls.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .stream-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .stream-controls {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        input[type="text"] {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(45deg, #54a0ff, #2e86de);
            color: white;
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(84, 160, 255, 0.4);
        }
        
        .video-container {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin: 20px 0;
        }
        
        #videoPlayer {
            width: 100%;
            height: 500px;
            background: #000;
        }
        
        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .status-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #333;
        }
        
        .log-section {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .alert-info {
            background: #cce7ff;
            color: #004085;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé• RTSP Stream Manager</h1>
            <p>Real-time streaming with automatic resource management</p>
        </div>
        
        <div class="content">
            <div class="stream-section">
                <div class="stream-controls">
                    <div class="form-group">
                        <label for="indicatorId">Indicator ID</label>
                        <input type="text" id="indicatorId" value="123" placeholder="Enter indicator ID">
                    </div>
                    <button class="btn btn-primary" onclick="startStream()">‚ñ∂ Start Stream</button>
                    <button class="btn btn-danger" onclick="stopStream()">‚èπ Stop Stream</button>
                    <button class="btn btn-info" onclick="checkStatus()">üìä Status</button>
                </div>
                
                <div class="form-group">
                    <label for="rtspUrl">RTSP URL</label>
                    <input type="text" id="rtspUrl" 
                           value="rtsp://admin:Rtsp@@$2025!@!@@92.39.91.145:18556/LiveMedia/ch1/Media1/" 
                           placeholder="Enter RTSP URL">
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>Processing stream request...</div>
            </div>
            
            <div id="alerts"></div>
            
            <div class="video-container">
                <video id="videoPlayer" controls poster="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzMzMzMzMyIvPgogIDx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNjY3ZWVhIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5ObyBTdHJlYW08L3RleHQ+Cjwvc3ZnPg==">
                    Your browser does not support the video tag.
                </video>
            </div>
            
            <div class="status-bar">
                <div class="status-card">
                    <div class="status-title">Stream Status</div>
                    <div class="status-value" id="streamStatus">Not Started</div>
                </div>
                <div class="status-card">
                    <div class="status-title">Active Streams</div>
                    <div class="status-value" id="activeStreams">-</div>
                </div>
                <div class="status-card">
                    <div class="status-title">Current Stream</div>
                    <div class="status-value" id="currentStream">None</div>
                </div>
                <div class="status-card">
                    <div class="status-title">Server Health</div>
                    <div class="status-value" id="serverHealth">Checking...</div>
                </div>
            </div>
            
            <div class="stream-section">
                <h3>üìã Activity Log</h3>
                <div class="log-section" id="logContainer">
                    <div>[INFO] Stream Manager initialized</div>
                    <div>[INFO] Ready to start streaming</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8088/api';
        const STREAM_BASE = './';
        let hls;
        let currentIndicatorId = null;
        let heartbeatInterval = null;
        let isPageVisible = true;
        let isVideoPlaying = false;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkServerHealth();
            setInterval(checkServerHealth, 30000); // Check every 30 seconds
            setupVisibilityHandlers();
            setupVideoEventHandlers();
            log('System ready for streaming', 'INFO');
        });
        
        // Handle page visibility changes
        function setupVisibilityHandlers() {
            document.addEventListener('visibilitychange', function() {
                isPageVisible = !document.hidden;
                log(`Page visibility changed: ${isPageVisible ? 'visible' : 'hidden'}`, 'INFO');
                
                if (!isPageVisible && currentIndicatorId) {
                    log('Page hidden - stopping heartbeat', 'INFO');
                    stopHeartbeat();
                } else if (isPageVisible && currentIndicatorId && isVideoPlaying) {
                    log('Page visible and video playing - resuming heartbeat', 'INFO');
                    startHeartbeat(currentIndicatorId);
                }
            });
        }
        
        // Setup video event handlers
        function setupVideoEventHandlers() {
            const video = document.getElementById('videoPlayer');
            
            video.addEventListener('play', function() {
                isVideoPlaying = true;
                log('Video started playing', 'SUCCESS');
                if (currentIndicatorId && isPageVisible) {
                    startHeartbeat(currentIndicatorId);
                }
            });
            
            video.addEventListener('pause', function() {
                isVideoPlaying = false;
                log('Video paused', 'INFO');
            });
            
            video.addEventListener('ended', function() {
                isVideoPlaying = false;
                log('Video ended', 'INFO');
            });
        }
        
        // Cleanup when page is unloaded
        window.addEventListener('beforeunload', function() {
            log('Page unloading - cleaning up', 'INFO');
            stopHeartbeat();
            if (currentIndicatorId) {
                // Send final stop request (fire and forget)
                fetch(`${API_BASE}/stream/stop`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({indicator_id: currentIndicatorId}),
                    keepalive: true
                }).catch(() => {
                    // Fallback with sendBeacon
                    navigator.sendBeacon(`${API_BASE}/stream/stop`, JSON.stringify({
                        indicator_id: currentIndicatorId
                    }));
                });
            }
        });
        
        // Logging function
        function log(message, type = 'INFO') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] [${type}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Show alert
        function showAlert(message, type = 'info') {
            const alertsContainer = document.getElementById('alerts');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertsContainer.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Show/hide loading
        function setLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // Check server health
        async function checkServerHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                document.getElementById('serverHealth').textContent = data.status;
                document.getElementById('activeStreams').textContent = data.active_streams || 0;
                
                if (data.status === 'healthy') {
                    document.getElementById('serverHealth').style.color = '#28a745';
                } else {
                    document.getElementById('serverHealth').style.color = '#dc3545';
                }
            } catch (error) {
                document.getElementById('serverHealth').textContent = 'Offline';
                document.getElementById('serverHealth').style.color = '#dc3545';
                log(`Health check failed: ${error.message}`, 'ERROR');
            }
        }
        
        // Start stream
        async function startStream() {
            const indicatorId = document.getElementById('indicatorId').value.trim();
            const rtspUrl = document.getElementById('rtspUrl').value.trim();
            
            if (!indicatorId || !rtspUrl) {
                showAlert('Please enter both Indicator ID and RTSP URL', 'error');
                return;
            }
            
            setLoading(true);
            log(`Starting stream for indicator: ${indicatorId}`, 'INFO');
            
            try {
                const url = `${API_BASE}/stream/start?indicator_id=${encodeURIComponent(indicatorId)}&rtsp_link=${encodeURIComponent(rtspUrl)}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    currentIndicatorId = indicatorId;
                    document.getElementById('streamStatus').textContent = 'Active';
                    document.getElementById('streamStatus').style.color = '#28a745';
                    document.getElementById('currentStream').textContent = indicatorId;
                    
                    showAlert('Stream started successfully!', 'success');
                    log(`Stream started: ${data.stream_path}`, 'SUCCESS');
                    
                    // Start HLS playback (heartbeat will start when video actually plays)
                    const hlsUrl = `${STREAM_BASE}${data.stream_path}`;
                    await startHLSPlayback(hlsUrl);
                    
                } else {
                    throw new Error(data.error || 'Failed to start stream');
                }
            } catch (error) {
                log(`Failed to start stream: ${error.message}`, 'ERROR');
                showAlert(`Failed to start stream: ${error.message}`, 'error');
                document.getElementById('streamStatus').textContent = 'Error';
                document.getElementById('streamStatus').style.color = '#dc3545';
            } finally {
                setLoading(false);
            }
        }
        
        // Stop stream
        async function stopStream() {
            const indicatorId = document.getElementById('indicatorId').value.trim();
            
            if (!indicatorId) {
                showAlert('Please enter Indicator ID', 'error');
                return;
            }
            
            setLoading(true);
            log(`Stopping stream for indicator: ${indicatorId}`, 'INFO');
            
            try {
                const response = await fetch(`${API_BASE}/stream/stop`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ indicator_id: indicatorId })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('streamStatus').textContent = 'Stopped';
                    document.getElementById('streamStatus').style.color = '#ffc107';
                    document.getElementById('currentStream').textContent = 'None';
                    currentIndicatorId = null;
                    
                    showAlert('Stream stopped successfully!', 'success');
                    log(`Stream stopped for indicator: ${indicatorId}`, 'SUCCESS');
                    
                    // Stop heartbeat
                    stopHeartbeat();
                    
                    // Stop HLS playback
                    stopHLSPlayback();
                    
                } else {
                    throw new Error(data.error || 'Failed to stop stream');
                }
            } catch (error) {
                log(`Failed to stop stream: ${error.message}`, 'ERROR');
                showAlert(`Failed to stop stream: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }
        
        // Send heartbeat to keep stream alive
        async function sendHeartbeat(indicatorId) {
            try {
                const url = `${API_BASE}/stream/heartbeat?indicator_id=${encodeURIComponent(indicatorId)}`;
                log(`Sending heartbeat to: ${url}`, 'DEBUG');
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úì Heartbeat successful for indicator: ${indicatorId}`, 'SUCCESS');
                    return true;
                } else {
                    log(`‚úó Heartbeat failed: ${data.error}`, 'ERROR');
                    return false;
                }
            } catch (error) {
                log(`‚úó Heartbeat network error: ${error.message}`, 'ERROR');
                return false;
            }
        }
        
        // Start heartbeat timer
        function startHeartbeat(indicatorId) {
            stopHeartbeat(); // Clear any existing interval
            
            // Only start heartbeat if page is visible and video is playing
            if (!isPageVisible || !isVideoPlaying) {
                log(`Heartbeat not started: pageVisible=${isPageVisible}, videoPlaying=${isVideoPlaying}`, 'INFO');
                return;
            }
            
            log(`Starting heartbeat for indicator: ${indicatorId}`, 'INFO');
            
            // Send initial heartbeat immediately
            sendHeartbeat(indicatorId);
            
            // Then send every 10 seconds (more frequent for better reliability)
            heartbeatInterval = setInterval(async () => {
                // Double check visibility before sending heartbeat
                if (isPageVisible && isVideoPlaying) {
                    const success = await sendHeartbeat(indicatorId);
                    if (!success) {
                        log('Heartbeat failed, stream may be stopped by server', 'WARN');
                    }
                } else {
                    log('Stopping heartbeat: page not visible or video not playing', 'INFO');
                    stopHeartbeat();
                }
            }, 5000); // Send heartbeat every 10 seconds
        }
        
        // Stop heartbeat timer
        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
                log('Heartbeat stopped', 'INFO');
            }
        }
        
        // Check stream status
        async function checkStatus() {
            const indicatorId = document.getElementById('indicatorId').value.trim();
            
            if (!indicatorId) {
                showAlert('Please enter Indicator ID', 'error');
                return;
            }
            
            log(`Checking status for indicator: ${indicatorId}`, 'INFO');
            
            try {
                const response = await fetch(`${API_BASE}/stream/status?indicator_id=${encodeURIComponent(indicatorId)}`);
                const data = await response.json();
                
                if (response.ok) {
                    const status = data.status;
                    document.getElementById('streamStatus').textContent = status;
                    
                    switch (status) {
                        case 'active':
                            document.getElementById('streamStatus').style.color = '#28a745';
                            break;
                        case 'stopped':
                            document.getElementById('streamStatus').style.color = '#ffc107';
                            break;
                        case 'not_found':
                            document.getElementById('streamStatus').style.color = '#dc3545';
                            break;
                    }
                    
                    showAlert(`Stream status: ${status}`, 'info');
                    log(`Status check: ${status}`, 'INFO');
                } else {
                    throw new Error(data.error || 'Failed to check status');
                }
            } catch (error) {
                log(`Status check failed: ${error.message}`, 'ERROR');
                showAlert(`Status check failed: ${error.message}`, 'error');
            }
        }
        
        // Wait for HLS manifest to be available
        async function waitForManifest(hlsUrl, maxRetries = 10, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(hlsUrl, { method: 'HEAD' });
                    if (response.ok) {
                        log(`Manifest ready after ${i + 1} attempt(s)`, 'SUCCESS');
                        return true;
                    }
                } catch (error) {
                    // Continue trying
                }
                
                log(`Waiting for manifest... attempt ${i + 1}/${maxRetries}`, 'INFO');
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            
            log('Manifest not available after maximum retries', 'ERROR');
            return false;
        }
        
        // Start HLS playback with retry logic
        async function startHLSPlayback(hlsUrl) {
            const video = document.getElementById('videoPlayer');
            
            log(`Initializing HLS playback: ${hlsUrl}`, 'INFO');
            
            // Stop any existing playback
            stopHLSPlayback();
            
            // Wait for the manifest file to be available
            log('Waiting for HLS manifest to be ready...', 'INFO');
            const manifestReady = await waitForManifest(hlsUrl, 20);
            
            if (!manifestReady) {
                showAlert('Stream initialization timeout. Try again in a few seconds.', 'error');
                return;
            }
            
            if (Hls.isSupported()) {
                hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 10,
                    manifestLoadingTimeOut: 10000,
                    manifestLoadingMaxRetry: 3,
                    manifestLoadingRetryDelay: 1000
                });
                
                let retryAttempts = 0;
                const maxRetries = 3;
                
                hls.loadSource(hlsUrl);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    log('HLS manifest loaded, starting playback', 'SUCCESS');
                    video.play().catch(e => {
                        log(`Autoplay prevented: ${e.message}`, 'WARN');
                        showAlert('Click the play button to start video', 'info');
                    });
                });
                
                hls.on(Hls.Events.ERROR, function(event, data) {
                    log(`HLS event: ${data.type} - ${data.details}`, data.fatal ? 'ERROR' : 'WARN');
                    
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                if (retryAttempts < maxRetries) {
                                    retryAttempts++;
                                    log(`Network error, retrying... (${retryAttempts}/${maxRetries})`, 'INFO');
                                    setTimeout(() => {
                                        hls.startLoad();
                                    }, 1000 * retryAttempts);
                                } else {
                                    log('Max network retry attempts reached', 'ERROR');
                                    showAlert('Network error: Unable to load stream', 'error');
                                }
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                if (retryAttempts < maxRetries) {
                                    retryAttempts++;
                                    log(`Media error, recovering... (${retryAttempts}/${maxRetries})`, 'INFO');
                                    hls.recoverMediaError();
                                } else {
                                    log('Max media recovery attempts reached', 'ERROR');
                                    showAlert('Media error: Unable to decode stream', 'error');
                                }
                                break;
                            default:
                                log('Unrecoverable error, destroying HLS instance', 'ERROR');
                                showAlert('Playback error: Please try restarting the stream', 'error');
                                hls.destroy();
                                break;
                        }
                    }
                });
                
                // Additional event listeners for better debugging
                hls.on(Hls.Events.MEDIA_ATTACHED, function() {
                    log('Media attached to HLS instance', 'INFO');
                });
                
                hls.on(Hls.Events.MANIFEST_LOADING, function() {
                    log('Loading HLS manifest...', 'INFO');
                });
                
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Native HLS support (Safari)
                log('Using native HLS support', 'INFO');
                video.src = hlsUrl;
                
                video.addEventListener('loadstart', () => log('Native HLS: Load started', 'INFO'), {once: true});
                video.addEventListener('canplay', () => log('Native HLS: Ready to play', 'SUCCESS'), {once: true});
                
                video.play().catch(e => {
                    log(`Autoplay prevented: ${e.message}`, 'WARN');
                    showAlert('Click the play button to start video', 'info');
                });
            } else {
                showAlert('HLS is not supported in this browser', 'error');
                log('HLS not supported in this browser', 'ERROR');
            }
        }
        
        // Stop HLS playback
        function stopHLSPlayback() {
            const video = document.getElementById('videoPlayer');
            
            if (hls) {
                hls.destroy();
                hls = null;
                log('HLS playback stopped', 'INFO');
            }
            
            video.pause();
            video.src = '';
            video.load();
        }
        
        // Additional video event handlers for debugging
        function setupAdditionalVideoHandlers() {
            const video = document.getElementById('videoPlayer');
            video.addEventListener('loadstart', () => log('Video load started', 'INFO'));
            video.addEventListener('canplay', () => log('Video ready to play', 'SUCCESS'));
            video.addEventListener('playing', () => {
                log('Video playback started', 'SUCCESS');
                isVideoPlaying = true;
                if (currentIndicatorId && isPageVisible) {
                    startHeartbeat(currentIndicatorId);
                }
            });
            video.addEventListener('waiting', () => log('Video buffering...', 'WARN'));
            video.addEventListener('error', (e) => log(`Video error: ${e.message}`, 'ERROR'));
        }
        
        // Call this after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setupAdditionalVideoHandlers();
        });
    </script>
</body>
</html>